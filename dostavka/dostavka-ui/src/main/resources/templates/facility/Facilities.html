<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


<head>
<link th:rel="stylesheet" th:href="@{assets/datatable/datatables.min.css}" />
<th:block th:insert="fragments/page-parts :: body/head"></th:block>

<title th:text="#{app.title.facilities}">Title</title>
</head>

<body>
	<!-- preloader area start -->
	<div th:replace="fragments/template :: body/preloader"></div>
	<!-- preloader area end -->

	<!-- page container area start -->
	<div class="page-container">

		<!-- sidebar menu area start -->
		<div th:replace="fragments/template :: body/sidebar-menu"></div>
		<!-- sidebar menu area end -->

		<!-- main content area start -->
		<div class="main-content">

			<!-- header area start -->
			<div th:replace="fragments/template :: body/header-area"></div>
			<!-- header area end -->

			<!-- page title area start -->
			<div th:replace="fragments/template :: body/page-title-area(~{::h4},~{::li})">
 				<h4 class="page-title fa-pull-left" th:text="#{menu.main.facilities}">Title</h4>
                <li><span th:text="#{menu.main.facilities}">Facility</span></li>  				
			</div>			
			<!-- page title area end -->

			<div class="main-content-inner p-1">
				<div th:replace="facility/FacilitiesMain :: body"></div>
			</div>
		</div>
		<!-- main content area end -->

		<!-- footer area start-->
		<footer>
			<div class="footer-area">
				<div th:replace="fragments/page-parts :: body/footer"></div>
			</div>
		</footer>
		<!-- footer area end-->

	</div>
	<!-- page container area end -->

	<!-- offset area start -->
	<div th:replace="fragments/template :: body/offset-area"></div>

	<div th:replace="fragments/page-parts :: body/bottom"></div>
	<script th:src="@{assets/datatable/datatables.min.js}"></script>
	<th:block
		th:replace="fragments/scripts/datatables :: body/true_false_show_check_func" />
	<script th:inline="javascript">
	
	var childEditors = {};  // Globally track created chid editors
	$(document).ready(function() {    
		// Generate table ID
	    function getTableId(level, uniqueData) {
	      // level = child level.
	      // uniqueData - unique data value in table.
	      return level + '-' + uniqueData.replace(' ', '-'); // Replace sapces with dashes
	    }
	    
	    // Return table with id generated from row's name field
	    function format(rowData, tableId) {
	      // rowData - data for the table.
	      // tableId - unique table ID for child table.
	      // This function just builds the table tag.
	      return '<table id="' + tableId + '" class="table table-striped table-hover table-sm table-bordered" style="padding-left:2em;">'+
	             '</table>';  
	    }
	
	
		var locE = [[@{assets/datatable/English.json}]];
		var locR = [[@{assets/datatable/Russian.json}]];
		var locU = [[@{assets/datatable/Ukrainian.json}]];
	    var localecallstr = ( [[${#locale.language}]] == "en" )? locE :( [[${#locale.language}]] == "ru" )? locR: locU ;
	    var facilitiesTable = $('#facilities-table').DataTable({
	    	dom:'Bfrtip',
	        "processing": true,
	        "serverSide": true,
	        scrollY:        '50vh',
	        scrollCollapse: true,
	        paging:         true,
            select: true,
	    	
	    	buttons:{
	    		dom: {
	    			button: {
	    		      className: 'btn-outline-primary'
	    			}
	    		},
	    		buttons: [
	    			{ 
			    		"extend": 'print', 
			    		"text":'<span class="fas fa-print"></span>',
			    		"className": 'btn btn-xs'
		    		},
	    			{ 
			    		"extend": 'pdf', 
			    		"text":'<span class="far fa-file-pdf"></span>',
			    		"className": 'btn btn-xs'
		    		},
		    		{
			    		"text":'<span class="fas fa-plus"></span>',
			    		"className": 'btn btn-xs',
		    		    "action": function ( e, dt, node, config ) {
		    		    	onAddNewFacilityButtonModalClick();
		    		    }
		    		},
		    		{
			    		"text":'<span class="fas fa-sync-alt"></span>',
			    		"className": 'btn btn-xs',
		    		    "action": function ( e, dt, node, config ) {
		    		    	//dt.clear().draw();
		    		    	dt.ajax.reload(null,false);
		    		    }
		    		}
		    	]
	    	},
	        
	        "lengthMenu": [
	        	[ 25, 50, 100, -1], [ 25, 50, 100, "All"]
	        ],
	        
	        "pagingType": "numbers",
	        
	        "ajax": {
	            "url": [[@{${T(ua.com.sipsoft.util.AppURL).API_V1_FACILITIES_PAGES}}]] ,
	            "type": "POST",
	            "dataType": "json",
	            "contentType": "application/json",
	            "data": function (d) {
	                return JSON.stringify(d);
	            }
	        },
	        
			"language": {
    				"url": localecallstr
	    	},
	    	
    		"columns": [
    			{
    	       		className: 'details-control main-table',
    	       		orderable: false,
    	      		data: null,
    	       		defaultContent: '',
    	       		width: '3rem'
    	    	},
	        	{"data": "id","width": "9rem"},
	            {"data": "name","width": "100%"},
	            {
	            	"data": null,
	            	"bSortable": false, 
	            	"width": "5rem",
		            "defaultContent": '<a class="btn btn-xs btn-link text-primary" data-name="editButton"><i class="[(@{${T(ua.com.sipsoft.util.UIIcon).BTN_EDIT.getClassCSS()}})]" title="[(#{button.edit})]"></i></a>',
	        		"targets": -1, 
	        		responsivePriority: 2
	        	}
	        ],
	        
	        "order": [
	        	[1,'asc']
	        ]
	    	
	    });

	    // Add event listener for for main talbe to open and close first level child details
	    $('#facilities-table tbody').on('click', 'td.main-table', function () {
	       var tr = $(this).closest('tr');
	       var row = facilitiesTable.row( tr );
	       var rowData = row.data();
	        
	   
	       if ( row.child.isShown() ) {
	         // This row is already open - close it
	         row.child.hide();
	         tr.removeClass('shown');
	          
	         // Destroy the Child Datatable
	         $('#' + 'addr-table-' + rowData.id).DataTable().destroy();
	       }
	       else {
	         
	         var tableId = 'addr-table-' + rowData.id; //getTableId("1", rowData.id);
	         row.child(format(tableId, tableId)).show();

	         $('#' + tableId).DataTable({
	            dom: "Bt",
	            scrollY: '200px',
	            destroy: true,
		        scrollCollapse: true,
	            select: true,
 		        "ajax": function (data, callback, settings) {
 		        	$.ajax({
			            "url": [[@{${T(ua.com.sipsoft.util.AppURL).API_V1_FACILITIES}}]]  +
			            "/" + rowData.id + [[${T(ua.com.sipsoft.util.AppURL).FACILITIESADDR}]],
			            "type": "GET",
			            "dataType": "json",
			            "contentType": "application/json",
			            //timeout: 3000,
			            "async":true,
					})
					.then( function(facilityAddresses) {
//		                var data = JSON.parse(dt);
		                var display = [];
//						console.log(facilityAddresses);
						$.each(facilityAddresses, function (index, value) {
//						  console.log(value);
						  display.push(value);
						});
		                callback({data: display});
		         
		              });
 		        },		        
	            columns: [
					{ data: "id", title: '[(#{entity.facilityaddr.addrid})]',"width": "9rem","orderable": "true" },
					{ data: "addressesAlias", title: '[(#{entity.facilityaddr.alias})]',"width": "30%","orderable": "true" },
					{ data: "address", title: '[(#{entity.facilityaddr.address})]',"width": "30%","orderable": "true" },
					{ data: "defaultAddress", title: '[(#{entity.facilityaddr.default})]',"render": true_false_show_check_func, "width": "10%","orderable": "true" },
					{ data: "lat", title: '[(#{entity.facilityaddr.lat})]',"width": "15%","orderable": "true" },
					{ data: "lng", title: '[(#{entity.facilityaddr.lng})]',"width": "15%","orderable": "true" },
					{ 
						data: null, 
		            	title: '[(#{grid.colum.actions})]',
			            "bSortable": false, 
			            "width": "5rem",
				        "defaultContent": '<a class="btn btn-xs btn-link text-primary"  data-name="editAddrButton"><i class="[(@{${T(ua.com.sipsoft.util.UIIcon).BTN_EDIT.getClassCSS()}})]" title="[(#{button.edit})]"></i></a>',
			        	"targets": -1, 
			        	responsivePriority: 2
			        },
		            ],
			        "aaSorting": [
			        	[3,'desc'],[0,'asc']
				], 
 		        
		    	buttons:{
		    		dom: {
		    			button: {
		    		      className: 'btn-outline-primary'
		    			}
		    		},
		    		buttons: [
			    		{
				    		"text":'<span class="fas fa-plus"></span>',
				    		"className": 'btn btn-xs',
			    		    "action": function ( e, dt, node, config ) {
			    		    	onAddNewFacilityAddrButtonModalClick(rowData.id);
			    		    }
			    		},
			    		{
				    		"text":'<span class="fas fa-sync-alt"></span>',
				    		"className": 'btn btn-xs',
			    		    "action": function ( e, dt, node, config ) {
			    		    	//dt.clear().draw();
			    		    	dt.ajax.reload(null,false);
			    		    }
			    		}
			    	]
		    	}
	         });
	          
	         tr.addClass('shown');
	      }
	    });
     });
	              

	</script>
	<!-- </th:block> -->
	
	<!-- Edit Facility modal form part -->
	<div th:replace="facility/facilityEditor :: body/facilityEditor"></div>

	<!-- Edit Facility modal form part -->
	<div th:replace="facility/facilityAddrEditor :: body/facilityAddrEditor"></div>

</body>

</html>